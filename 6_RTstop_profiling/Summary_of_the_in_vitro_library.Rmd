---
title: "Summary of the in vitro library"
author:
- name: Mario Keller
  affiliation: Faculty of Biological Sciences, Goethe University Frankfurt
output:
    BiocStyle::html_document:
      toc: TRUE
      toc_float: TRUE
      code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      crop=NULL, results = TRUE)
```

```{r libraries}
library(tidyverse)
library(knitr)
library(janitor)
library(GenomicRanges)
```

```{r defineTheme}
myTheme <- theme_bw() +
    theme(axis.text = element_text(size = 8, colour="black"),
          axis.title = element_text(size=10, colour="black"),
          axis.ticks=element_line(color="black"),
          axis.ticks.length=unit(.15, "cm"),
          panel.border=element_rect(color="black", fill = NA),
          panel.background = element_blank(),
          plot.background = element_blank(),
          legend.text = element_text(size=8),
          plot.title = element_text(size=8),
          legend.position = "none")
```

```{r paths}
projectDir <- "/Users/mariokeller/projects/HNRNPH_project/Tretow_et_al_2023"

dataDir <- paste0(projectDir, "/data")
iClipDir <- paste0(projectDir, "/4_iCLIP_analysis")
rG4Dir <- paste0(projectDir, "/5_rG4_analysis")
RTstopDir <- paste0(projectDir, "/6_RTstop_profiling")

```

# Background

In this report the complexity of the in vitro library is summarized. Meaning the
number of constructs with/without BSs and with/without predicted rG4s. In
addition, the information is added whether at least one BS overlaps a predicted
rG4 in the genome. Ultimately, the information of the RTstop profiling is
incorporated.

# Data

Predicted rG4 around the binding sites and within the constructs are loaded and
used to annotate the constructs.

```{r input}

predicted_rG4s_around_binding_sites <- readRDS(paste0(rG4Dir,"/rds_files/bindingSitesG4s.rds"))

constructClassification <- readRDS(paste0(dataDir,
                         "/RTstop_profiling/constructClassification.rds"))
constructClassification <- clean_names(constructClassification,
                                       case = "lower_camel")

constructInformation <- readRDS(paste0(dataDir,
                         "/RTstop_profiling/constructInformation.rds"))
constructInformation <- clean_names(constructInformation, case = "lower_camel")


rG4s_no_overlaps <- readRDS(paste0(RTstopDir, "/rds_files/pqsfinderResults_noOverlaps.rds"))

constructs_gr <- constructInformation %>% select(constructId, regionId, strand, coords, type, region)
constructs_gr$coords <- paste0(constructs_gr$coords,":",constructs_gr$strand)

meta <- constructs_gr %>% select(-strand)
constructs_gr <- GRanges(constructs_gr$coords)
mcols(constructs_gr) <- meta
constructs_gr$pred_rG4 <- (rG4s_no_overlaps %>% lengths) > 0

constructs_gr <- constructs_gr[1:12000]


binding_sites <- readRDS(paste0(iClipDir, "/rds_files/HNRNPH_binding_sites.rds"))
binding_sites$overlaps_predicted_rG4 <- countOverlaps(binding_sites, predicted_rG4s_around_binding_sites) > 0


hits <- findOverlaps(binding_sites, constructs_gr, type="within") %>% as.data.frame
hits$binding_site_overlaps_predicted_rG4 <- binding_sites$overlaps_predicted_rG4[hits$queryHits]
hits <- hits %>%
    group_by(subjectHits) %>%
    summarize(binding_site = TRUE,
              binding_site_overlaps_predicted_rG4 = any(binding_site_overlaps_predicted_rG4))

constructs_gr$BS <- FALSE
constructs_gr$BS[hits$subjectHits] <- TRUE 

constructs_gr$BS_with_pred_rG4 <- FALSE
constructs_gr$BS_with_pred_rG4[hits$subjectHits] <- hits$binding_site_overlaps_predicted_rG4 

# Adjust the rare cases where BS_with_pred_G4 is TRUE but pred_G4 is FALSE
constructs_gr$BS_with_pred_rG4[constructs_gr$BS_with_pred_rG4 == TRUE & constructs_gr$pred_rG4 == FALSE] <- FALSE

```

# Complexity of the library

IMPORTANT! For a small number of constructs we have the case that they are labeled
to not have a predicted rG4 but to have a binding site that overlaps a predicted
rG4. This is for instance the case when the binding site was overlapping the 
last G-tract of a precited rG4 and the full sequence of the rG4 is not part 
of the construct.

This is the complexity when considering all 12.000 constructs.

```{r}
constructs_gr %>% mcols %>% as.data.frame %>% count(BS, BS_with_pred_rG4, pred_rG4)
```

This is the complexity when considering the reduced 3.000 constructs. Always
the first of the four technical "replicates" is used. In rare cases there is a 
discrepancy in the presence of rG4s among the four technical replicates as the 
barcode and L3 linker have been considered in the rG4 prediction.

```{r}
constructs_gr[!duplicated(constructs_gr$regionId)] %>% mcols %>% as.data.frame %>% count(BS, BS_with_pred_rG4, pred_rG4)
```

# Incorporating RTstop profiling results

```{r}

constructs_gr <- constructs_gr[constructs_gr$constructId %in% constructClassification$constructId]
constructs_gr$measured_rG4 <- constructClassification$regulationGroup[match(constructs_gr$constructId, constructClassification$constructId)]
constructs_gr$measured_rG4 <- ifelse(constructs_gr$measured_rG4 == "G4", T, F)

```

For the constructs with the classification from the RTstop profiling (1.060 x rG4
and 1.109 x non-rG4) following information regarding binding sites is obtained:

```{r}
constructs_gr %>% mcols %>% as.data.frame %>% count(BS, BS_with_pred_rG4, pred_rG4, measured_rG4)
```

# Session Information

```{r}
sessionInfo()
```
